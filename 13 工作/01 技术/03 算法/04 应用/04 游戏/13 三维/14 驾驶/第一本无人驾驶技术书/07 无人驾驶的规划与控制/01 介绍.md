# 规划与控制简介

无人车作为一个复杂的软硬件结合系统，其安全可靠运行需要车载硬件、传感器集成、感知、预测，以及控制规划等多个模块的协同配合工作。作者认为最关键的部分是感知预测和控制规划的紧密配合。


这里的控制规划（Planning＆Control）在广义上可以划分成

- 无人车路由寻径（Routing）
- 行为决策（Behavioral Decision）
- 动作规划（Motion Planning）
- 反馈控制（Feedback Control）
- 等几个部分

无人车软件系统控制规划示意：

<p align="center">
    <img width="70%" height="70%" src="http://images.iterate.site/blog/image/20200209/uveDspDYFdRc.png?imageslim">
</p>

简单介绍如下：

- 控制规划模块的最上游是路由寻径（Routing）模块，其作用在简单意义上可以理解为实现无人车软件系统内部的导航功能，即在宏观层面上指导无人车软件系统的控制规划模块按照什么样的道路行驶，从而实现从起始点到目的地点。值得注意的是，这里的路由寻径虽然在一定程度上类似传统的导航，但其细节上紧密依赖于专门为无人车导航绘制的高精度地图，所以和传统的导航有本质不同。
- 路由寻径模块产生的路径信息，直接被下游的行为决策模块所使用。这里的行为决策模块，可以直观地理解成无人车的“副驾驶”。行为决策接收路由寻径的结果，同时也接收感知预测和地图信息。综合这些输入信息，行为决策模块在宏观上决定了无人车如何行驶。这些行为层面的决策包括在道路上的正常跟车，在遇到交通灯和行人时的等待避让，以及在路口和其他车辆的交互通过等。例如，路由寻径要求无人车保持在当前车道（Lane）行驶，当感知到前方有一辆正常行驶的车辆时，行为决策的一个决定便很可能是下达跟车（follow）命令。行为决策模块根据具体实现不同，在宏观上定义的输出指令集合也多种多样。实现行为决策模块的方法相对较多，而且没有非常严格的规则要遵循。实际上，在无人车系统设计中，行为决策模块有时被设计成独立的逻辑模块，有时其功能在某种程度上和下游的动作规划模块融合到了一起实现。
- 正是因为行为决策和动作规划需要紧密协调配合，在设计实现两个模块时的一个重要的基本准则是，行为决策模块的输出逻辑需要和下游的动作规划模块逻辑配合一致。动作规划模块，在图7-1所示的划分中，解决的是具体的无人车动作（Motion）的规划问题。其功能可以理解为，在一个较小的时空区域内，具体解决无人车从A点到B点如何行驶的问题。这里动作规划模块需要解决的问题，相对行为决策需要解决的问题，又更加具体了一步。动作规划需要具体把一个短暂时间t内从A到B的中间路径点做出规划，包括选择途经哪些具体的路径点，以及到达每个路径点时，无人车需要达到的速度、朝向、加速度，以及车轮转向等。不仅如此，动作规划还需要保证两点：一是在后续时间内，生成从A到B的时空路径需要保持一定的一致性；二是这些生成的A到B之间的路径点，包括到达每个点的速度、朝向、加速度等，在下游反馈控制的车辆和道路的物理属性范围内，是可以实际操作的。从上图以看到，为了了解所处的周围路况环境并做出行为决策，担当“副驾驶”角色的行为决策模块需要感知和地图定位的输出作为输入（图中实线）。由于行为决策和动作规划模块的紧密联系，一般在系统设计时，我们也会同样让感知和地图定位结果接入动作规划模块。这样相对冗余的设计的好处有两点：一方面，如果仅仅依赖行为决策模块作为relay传递感知结果，那么在行为决策模块计算完成前出现的新感知物体将会被忽略，给无人车的安全带来隐患；二是如果行为决策模块出现了问题，这时的动作规划虽然没有了对交规和四周环境行为层面的决策，但仍然拥有感知和地图完整信息，也能实现最基本的避让，提供无人车的安全性。
- 规划控制最下层的模块是反馈控制模块。这是一个直接和无人车底层控制接口CAN-BUS对接的模块，其核心任务是消化上层动作规划模块的输出轨迹点，通过一系列结合车身属性和外界物理因素的动力学计算，转换成对车辆Drive-By-Wire控制的油门、刹车，以及方向盘信号，从而尽可能地控制车去实际执行这些轨迹点。反馈控制模块主要涉及对车辆自身控制，以及和外界物理环境交互的建模。

上述四个模块便是无人车控制规划软件系统的最主要的功能模块。这种模块的划分方法，非常有效地将无人车控制规划这样一个复杂问题，按照计算逻辑从抽象到具体做出了非常合理的切分。这样的划分使得每个模块可以各司其职专注解决本层次的问题，使得复杂软件系统的开发工作，可以实现并行化和模块化，大大提高了开发效率，这是这一划分方法的优势所在。当然随之而来的问题，便是模块之间的协调一致问题，其中最重要的便是模块之间计算结果的一致性问题。

本质上，行为决策、动作规划和反馈控制都是在不同层面解决同一个问题。同时他们之间由于上下游关系的存在，其计算结果又互相依赖，所以在具体设计实现各个模块时的一个最重要的准则便是尽可能保证计算结果的一致性和可执行性。行为决策模块在做出决定时，要尽可能保证前后一致且最大可能地让下游动作规划可以执行。动作规划规划的轨迹速度也应当严格在下游反馈控制可以执行的范围内。当冲突出现时，一个普遍的解决冲突的准则是尽可能让上游模块去解决问题迁就下游模块，而不是去push推动下游模块的极限。

下面我们就按照图7-1中的模块划分，按照从上游到下游的顺序，详细介绍每个模块需要解决的问题。同时我们对于每个模块，结合其需要解决问题的具体场景，详细介绍一到两种常见算法的具体实现，从而使得读者对整套无人车控制规划软件系统的解决方案有一个全面又具体的体验。






# 动作规划

在行为决策层下游的模块是动作规划，其任务是将行为决策的宏观指令解释成一条带有时间信息的轨迹曲线，给底层的反馈控制进行实际对车的操作。

这里无人车的动作规划，可以看作是普通机器人动作规划（Robotic Motion Planning）的一种特殊场景。事实上，作者认为无人车的动作规划问题是整个机器人动作规划领域里相对简单的一个问题。这是因为车辆的轨迹是依附于一个二维平面的。车辆在方向盘、油门的操控下，其行驶轨迹的物理模型相对于普通的机器人姿态的动作轨迹更简单。

从DARPA无人车比赛开始，无人车动作规划便逐渐成为一个相对独立的模块[10]，尝试在城市道路行驶及停车等综合条件下解决路径规划的问题，也有一些在特定场景下的路径规划问题的解决方法。参考资料中的［4］和［11］列出了近年来动作规划的很多不同方向的工作，读者可以作为参考。

随着这些研究的进展，路径模块需要解决的问题也逐渐明晰：几乎所有动作规划都试图解决在一定的约束条件下优化某个范围内的时空路径问题。这里所谓的“时空路径”指车辆在一定时间段行驶的轨迹。该轨迹不仅包括位置信息，还包括整条轨迹的时间信息和车辆姿态：即到达每个位置的时间、速度，以及任何可能的和时间相关的运动变量如加速度、曲率、曲率的高阶导数等信息。由于车辆控制是一个不和谐的系统[12]，车辆的实际运行轨迹总是呈现出属于平滑的类似螺旋线的曲线簇的属性。因此，轨迹规划这一层面需要解决的问题，往往可以非常好地抽象成一个在二维平面上的时空曲线优化问题。

<p align="center">
    <img width="70%" height="70%" src="http://images.iterate.site/blog/image/20200210/GWAraHaYAs4c.png?imageslim">
</p>


考虑动作规划这个层面的优化问题所需要的两个要素：一是需要优化的函数（Object）/代价（Cost）目标；二是边界条件的限制（Constraint）。结合图7-1所示的整个系统框架，这里的优化目标函数，往往以Cost函数的形式呈现，优化的目标是找到满足边界条件限制的最小Cost的曲线。

这里的Cost和如下几个重要因素紧密相关。

- 首先是上游的行为决策输出的决策结果。作为下游直接规划无人车路线曲线的动作规划，其优化目的必须满足达到行为层面的要求。这些要求往往体现在曲线的长度不能超过某一停止线，曲线横向位移不能触碰到需要避让的物体等；
- 其次，由于我们着重考虑在城市综合道路（Urban Road）上的行驶，车辆行驶的曲线要考虑和道路的关系，即动作规划的曲线要满足能够沿道路行驶的基本要求，这些要求也会被转化成曲线的不同代价来体现；在动作规划的边界条件限制层，往往需要更多考虑的是如图7-1所示的下游反馈控制模块。例如，车辆的转向由方向盘控制导致车辆的曲率和曲率二阶导变化受到一定的限制。车辆的油门加速同样限制车辆的加速度的变化率不可能过大等。

这里我们借鉴参考资料［11］中的动作规划算法，提出一种更简单明确地将动作规划问题拆分成为两个问题：

- 轨迹规划（Trajectory Planning）
- 速度规划（Speed Planning）

来解决的思路。其中轨迹规划只解决在二维平面上，根据行为决策和地图信息定义的Cost函数下优化轨迹的问题。这里的轨迹不考虑速度因素，只是单纯的不同长度的轨迹曲线；而速度规划问题则是在选定了一个或者若干个轨迹（Trajectory）之后，解决用什么样的速度行驶这条轨迹的问题。相比于参考资料［11］中的联合优化带有时间和速度信息的时空轨迹，这样的方法使得每个层次定义的问题更加清晰和相对易于建模解决。虽然分开优化不一定能保证达到联合意义上的最优解，但是在实际的工程实践中，作者认为分开优化是更实际有效的解决方案。下面我们就分别详细介绍轨迹规划和速度规划的算法。

## 1 轨迹规划

1．车辆模型、道路定义，以及候选轨迹生成

我们首先介绍车辆和道路的数学模型。对于车辆，我们考虑车辆的姿态向量 $\bar{x}=(x, y, \theta, \kappa, v)$，其中 $(x, y)$ 表示车辆在二维平面的位置，$\theta$表示车辆的朝向，$\kappa$表示曲率（即朝向 $\theta$ 的变化率），$v$表示车辆的速度（即轨迹任意点的切线速度）。车辆的这些姿态变量的标量大小满足如下关系：


$$
\begin{array}{l}{\dot{x}=v \cos \theta} \\ {\dot{y}=v \sin \theta} \\ {\dot{\theta}=v \kappa}\end{array}
$$

其中曲率 $\kappa$ 的大小往往由系统的输入限制条件决定。在此基础上，考虑一条由车辆运动产生的连续轨迹（Path）。我们称沿着轨迹的方向的位移为S方向。轨迹相对于车辆姿态的系统关系由下列偏微分方程式给出：

$$
\begin{array}{l}{\mathrm{d} x / \mathrm{d} s=\cos (\theta(s))} \\ {\mathrm{d} y / \mathrm{d} s=\sin (\theta(s))} \\ {\mathrm{d} \theta / \mathrm{d} s=\kappa(s)}\end{array}
$$

注意这里我们并没有对 $\kappa$ 和 $\theta$之间的关系做出特定限制，即车辆可以在任意朝向 $\theta$ 上任意改变其曲率 $\kappa$ 。在实际的车辆模型中，车辆的曲率 $\kappa$ 和朝向 $\theta$ 之间是有一定限制的，但这个微小的模型偏差并不影响我们这个动作规划算法的一般性和实用性。

我们的轨迹规划（Trajectory Planning）算法非常依赖于地图中对于道路中心线（Center Line）的定义。这里我们认为道路是由道路的采样函数所定义。采样函数为：$r(s)=\left[r_{x}(s), r_{y}(s), r_{\theta}(s), r_{\kappa}(s)\right]$，其中$s$代表道路的中心线切向方向的位移（以后也称为纵向位移$S$）。与此对应的是道路的中心线垂直方向位移$l$ ，也称为横向位移。如果考虑一个车辆的姿态点具体关系，其各个分量由道路坐标系下的（s ，l）坐标，以及道路采样函数（s，l）决定，满足：


$$
\begin{array}{l}{x_{r}(s, l)=r_{x}(s)+l \cos \left(r_{\theta}(s)+\pi / 2\right)} \\ {y_{r}(s, l)=r_{y}(s)+l \sin \left(r_{\theta}(s)+\pi / 2\right)} \\ {\theta_{r}(s, l)=r_{\theta}(s)} \\ {\kappa_{r}(s, l)=\left(r_{K}(s)^{-1}-l\right)^{-1}}\end{array}
$$


其中曲率 $\kappa_{r}$在道路转弯的内侧加大（随纵向位移l加大），外侧则减小。我们使用右手坐标系，所以如图7-9所示，在靠近原点处朝x轴的正方向，纵向位移l朝着y轴正方向加大。假设对于某条道路Lane（k），其纵向宽度$l_k$保持不变。那么该条道路可以表示为一个随着中心线横向位移s的点集 $\left\{p\left(s, l_{k}\right): s \in \boldsymbol{R}^{+}\right\}$。我们称这样的一个坐标系统为SL坐标系统。

XY平面下的SL坐标系统及其网格划分：


<p align="center">
    <img width="70%" height="70%" src="http://images.iterate.site/blog/image/20200210/u9K7Iu36eIVq.png?imageslim">
</p>



在上述的车辆模型和道路模型下，我们讨论轨迹规划所产生的轨迹曲线。首先，我们定义车辆的轨迹（Trajectory）为一个从［0，1］区间到车辆姿态向量集合 $C=\{\vec{x}\}$ 的连续映射：$\rho:[0,1] \rightarrow C$。其中车辆的初始姿态向量为 $\vec{x}=(x, y, \theta, x)$。每条轨迹终点处如图7-10所示，轨迹1的终点姿态为 $\rho_{1}(1)=\boldsymbol{q}_{\mathrm{endl}}$，轨迹2的终点姿态向量为 $\rho_{2}(1)=\boldsymbol{q}_{\mathrm{end} 2}$，初始姿态 $\rho_{1}(0)=\rho_{2}(0)=q_{\text {init }}$。轨迹优化的目标便是在所有可能的轨迹曲线中，筛选出满足边界条件的轨迹曲线，再寻找一条/若干条最平滑且Cost函数最低的曲线。其中轨迹的候选曲线我们用类似在路由寻径模块中介绍的“撒点”的采样方式生成。


参考图7-10在某条Lane的SL坐标系下，均匀切分的S和L方向的方格内，在固定S和L间隔下，考虑每个 $\left(s_{i}, l_{j}\right)$ 区域的中心点。一条候选的轨迹便可以看作是沿着Lane的中心线纵向位移s方向连接不同Trajectory Point的平滑曲线。在图7-10所示的道路SL分割和采样下，可能的Trajectory Point有16个（4个s位置，4个l位置），从车辆的初始位置出发，我们只考虑在s方向为单调增大的可能，不考虑城市综合道路行驶中的倒车情况，那么总的候选曲线的条数为$4^4=256$条。轨迹优化便是要在这256条候选的曲线中找出最平滑且Cost最优的轨迹。

SL坐标系下道路的分割采样及可能的轨迹：

<p align="center">
    <img width="70%" height="70%" src="http://images.iterate.site/blog/image/20200210/lV0uMPmnfIMC.png?imageslim">
</p>

多项式螺旋线及车辆姿态的螺旋线示意图：

<p align="center">
    <img width="70%" height="70%" src="http://images.iterate.site/blog/image/20200210/fDC9yd4w9rQK.png?imageslim">
</p>


我们采用多项式螺旋线[13]连接轨迹点，从而生成候选的曲线。多项式螺旋线，如图7-11所示，代表了一类曲率可以用弧长（对应我们轨迹中的s方向）的多项式函数来表示的曲线簇。我们使用三阶（Cubic）或者五阶（Quintic）的多项式螺旋线，其曲率k和轨迹弧长s的关系k（s）为：

$$
k(s)=k_{0}+k_{1} s+k_{2} s^{2}+k_{3} s^{3}
$$

或：

$$
k(s)=k_{0}+k_{1} s+k_{2} s^{2}+k_{3} s^{3}+k_{4} s^{4}+k_{5} s^{5}
$$

这里我们使用三阶或者五阶的多项式螺旋线拟合，是遵循常见的已有动作规划方面工作的惯例。曲线的阶数对于其在曲线连续性方面并没有本质的影响，其他阶数（如四阶甚至更高阶）的多项式曲线簇也能够作为轨迹点之间的连接曲线。

三阶和五阶多项式在满足边界条件约束上有一个重要的区别：三阶多项式螺旋线会导致曲率的二阶导 $\mathrm{d} \kappa^{2} / \mathrm{d} s^{2}$（对应方向盘转速）的不连续，而五阶多项式则可以同时保证$\mathrm{d} \kappa / \mathrm{d} s$ 和 $\mathrm{d} \kappa^{2} / \mathrm{d} s^{2}$ 的连续性。三阶和五阶多项式螺旋线在速度较低时，该差别在反馈控制上引入的误差体现并不明显，但在速度较快时该误差不可忽略。

基于这种使用三阶（五阶）螺旋线连接的轨迹，其参数可以快速有效地通过梯度下降（Gradient Descent）的方法来搜索。以三阶多项式为例，我们考虑从车辆初始姿态 $q_{\text {init }}=\left(x_{I}, y_{I}, \theta_{I}, \boldsymbol{\kappa}_{I}\right)$ 到目标姿态 $q_{\text {goal }}=\left(x_{G}, y_{G}, \theta_{G}, k_{G}\right)$，且具有连续曲率的三阶螺旋线：$k(s)=k_{0}+k_{1} s+k_{2} s^{2}+k_{3} s^{3}$。在初始状态s=0时，考虑曲率的一阶导数和二阶导数均需要满足初始状态的限制，我们可以得到：

$$
\begin{array}{l}{\kappa_{0}=\kappa_{I}} \\ {\kappa_{1}=d \kappa(0) / d s} \\ {\kappa_{2}=d^{2} \kappa(0) / d s^{2}}\end{array}
$$

这样使得实际未知参数减少到2个 $\left(\kappa_{3}, s_{G}\right)$，利用梯度向量我们可以快速寻找到非常接近初始状态限制的三阶螺旋线的参数。

2．基于轨迹点的有向图构建和搜索

在之前描述的车辆道路模型、轨迹点以及连接轨迹点的多项式螺旋线等的设定之下，轨迹规划简化成针对个 $\left|l_{\text {total }} / \Delta l\right| \times\left|s_{\text {total }} / \Delta s\right|$ 轨迹点连接成的 $\left|l_{\text {total }} /\Delta l\right|^{\left| s_{\text {total }} / \Delta s \right|}$ 条潜在候选曲线的搜索问题。考虑这些轨迹点构成的图 $G=(V, E)$。其中每个轨迹点都是图中的一个节点 ，$v \in V, v=(x, y, s, l)$ ；对于任意两个节点，，当其对应的s坐标满足时，代表从x到y的三阶/五阶多项式螺旋曲线。最优的曲线搜索问题转化为在上述有向带权图上的“最短路径”搜索问题。需要注意，这里的最短路径较为特殊的是其不仅包含沿着路径的累积Cost，还包括了当路径轨迹确定后这条路径的整体Cost。考虑由轨迹点连接成的曲线τ，其中初始轨迹点为n0，轨迹终点为nk，那么该轨迹的Cost可以写成：

其中c（τ）代表沿该曲线行驶累积的Cost，Φ（τ）代表这条曲线在此终点终结而引入的Cost。如果将Φ（τ）函数写成按照轨迹点的增量形式，那么：

其中我们定义函数g（n）将表示“到达”节点n的最小Cost，注意该Cost包含沿途轨迹螺旋线的Cost累积而并不包括以n为终点而引起的整体轨迹曲线Cost增长。那么，考虑以为倒数第二个节点的所有轨迹中，最小Cost轨迹曲线的最后一个轨迹点nk的选取。该节点nk需要满足：

（1）存在节点到节点nk的有向边，也记为。

（2）对所有节点能够到达的节点集合（即存在有向边）中，以nk结束的轨迹曲线的总Cost最小。
这样我们可以更新为：。
我们可以用图7-12所示的动态编程算法来计算从车辆的初始位置n0节点起始，经过任意个可能的轨迹点，且保持在道路Lane的s方向递增的最小Cost的轨迹曲线。从图7-12可以看出，最小Cost轨迹所经过的轨迹点之间的连接是可以在进行图的遍历搜索的同时构建的。算法中g（n）代表了到达节点n的Cost，而φ（n）代表了整个轨迹的Cost，其中包括了到达n的Cost及以n为轨迹终点带来的附加Cost。前者g（n）是选择从当前节点展开到后续节点所增加Cost的依据（图7-12第13行）；而当选择从哪一个前驱节点到达当前节点时则考虑φ（n）作为评价标准（图7-12第11行）。当整个g（n）和φ（n）都计算完毕后，很容易通过我们的前驱节点映射prev_node来倒推出整个最小Cost的轨迹点序列。我们只需要增加一个虚拟的节点nf，且对于nf，构建连接nf的虚拟边。这样我们的任务便成为寻找一条连接n0至nf的轨迹点构成的最小Cost轨迹曲线。根据图7-12所示的算法，g（n）已经计算完毕，那么最后一个实际的轨迹点可以从中找出。




7-12　基于动态编程的轨迹点最小Cost轨迹算法

这里我们再简单介绍一下具体的轨迹曲线的Cost函数设计。考虑轨迹，其中c（τ）部分的Cost代表连接曲线轨迹点的部分代价。这里可以考虑如下因素来设计基于轨迹的Cost函数。

（1）道路层面：规划的轨迹曲线应当尽可能和道路的中心线切合。例如，当行为决策的输出是直行时，轨迹曲线的Cost会随着规划轨迹曲线偏离道路中心线的横向位移l加大而加大。
（2）障碍物层面：规划的轨迹曲线需要避让静态障碍物。例如，在图7-10SL坐标系下道路的分割采样及可能的轨迹，需要将静态的障碍物所占领的网格及其附近的网格的Cost调整到非常高。我们将在7.4.2节中结合速度规划讨论动态障碍物的规避。
（3）控制和舒适度层面：这个层面的Cost和操控的限制及乘客的舒适性紧密相关。规划的曲线应该尽量避免曲率（包括曲率导数）的较大变化等，使得乘客的舒适性得到保障。
再考虑整体曲线Cost的Φ（τ）部分，由于我们将速度规划（Speed Planning）的部分作为一个单独的问题来解决，那么Φ（τ）的Cost函数可以仅考虑轨迹曲线的纵向位移s部分。

其中第一项是线性Cost，代表了整体轨迹曲线偏向于纵向位移s较长的轨迹（Cost项为负代表对Cost进行减小discount），而第二项是一个非线性Cost，只有当整体的纵向位移s超过一定门限时才会触发。

7.4.2　速度规划

当轨迹规划给定了一条或者若干条选出的轨迹曲线后，动作规划模块需要解决的后续问题是在此轨迹的基础上加入速度相关的信息。这一问题我们称为速度规划。速度规划的目标是在给定的轨迹曲线上，在满足反馈控制的操作限制及符合行为决策的输出结果这两个前提下，将轨迹点赋予速度及加速度信息。我们已经将静态障碍物的规避部分在7.4.1节的轨迹规划中考虑，速度规划主要考虑的是对于动态障碍物的规避。本节中，我们引入S-T图这一概念，并且把无人车速度规划问题归纳成S-T图上的搜索问题进行求解。顾名思义，S-T图是一个关于时间和给定轨迹纵向位移的二维关系图。任何一个S-T图都是基于一条已经给定的轨迹曲线。根据无人车预测模块对动态障碍物的轨迹预测，每个动态障碍物都会在这条给定的轨迹上有所投影，从而产生对于一定S-T区域的覆盖。这里我们结合一个例子阐述基于S-T图的速度优化算法。

如图7-13所示，考虑一条轨迹规划选取的换道轨迹。此时，在需要换至的目标车道中有a和b两辆障碍车。简单而不失一般性，假设预测模块对这两辆车的预测轨迹都是沿着当前的左侧车道匀速直线行驶。那么a和b在这条选定的轨迹上的投影如图中的两块阴影区域所示。在某一个固定时刻，a和b在轨迹上的投影都是平行于s轴的线段。随着t的延伸，障碍物a和b在轨迹曲线上的投影如图7-13所示的阴影四边形并不断延伸。我们将S-T图类似于轨迹规划的地图划分也切割成小网格（Lattice Grid），对每个网格赋予Cost，那么速度规划问题也可以归纳成在这个网格图上的最小Cost路径搜索问题。主车在t=0时刻在s=0位置，主车需要最终到达s=s_end位置且经过网格的累计Cost最低。

图7-13　基于S-T图的速度规划搜索图

我们比较图7-13所示的三种速度规划方案：第一种方案（Speed Plan 1）在任意t时刻，主车在轨迹上的s方向一直落后于a和b，注意主车还有一个等于Speed Plan 1对应直线斜率的速度，最终可以到达s=s_end位置（图中的轨迹没有画出），在实际行驶中，这个方案对应于让a和b都先通过主车换道需要经过的轨迹部分，然后再进行换道；第二种方案（Speed Plan 2）从某一时刻开始在轨迹上的s位移便一直领先于车辆a，但一直落后于车辆b，在实际行驶中对应先加速在a进入选定的换道轨迹前进入换道轨迹，但等待位置较为靠前的b先进入轨迹；第三种方案（Speed Plan 3）对应加速在a和b进入选定的换道轨迹前进入轨迹。此时，假设上游的行为决策模块的输出是针对障碍车辆a进行让先（Yield），对障碍车辆b进行抢先（Overtake），那么速度规划算法应当结合Cost选出第二种方案（Speed Plan 2）。

结合上游行为决策输出的信息，动作规划模块的速度规划可以灵活设置障碍物体周边的Cost，达到调整速度方案的目的。例如，当上游决定对于物体a进行抢先决策时，在S-T图上物体a的运动轨迹上方的网格的Cost就可以调成偏小；假设对一个动态障碍物体需要让先，那么可以将该物体下方的网格的Cost调小。同时，为了避免任何潜在的碰撞（Collision），所有动态障碍物体的轨迹经过的网格的Cost都需要调大。除此之外，还需要考虑一条给定速度方案在加速度等控制方向的Cost。例如，S-T图上过“陡峭”的曲线代表加速度大甚至不连续，这样很有可能导致反馈控制模块（Feedback Control）无法实际执行。所以，每条曲线所代表的速度方案均有一个整体的Cost。实际上，如何根据上游输出和下游限制来调整Cost，是速度规划中的S-T图算法的关键设置。在设置好Cost的基础上，最小Cost轨迹的产生可以用类似`A*` 或者Dijkstra等简单搜索算法实现，本节将不再赘述。在得到了最小Cost的S-T路径后，可以简单算出任何一个轨迹位置的速度（对应S-T图任意点斜率）和加速度（斜率的导数），从而完成速度规划的计算。

结合7.4.1节中的轨迹规划和7.4.2节中的速度规划，至此我们已经能够将无人车在基于周边环境和行驶目的地下做出的行为层面决策，通过一些列模块的计算转化成具体的带有位置、速度信息的时空轨迹点。我们将轨迹规划输出的曲线上按照均匀时间间隔提取抽样点，并且将速度规划的结果信息填充到这些抽样点中。这些带有速度、加速度、角加速度的时空轨迹点将被发给下游的反馈控制模块，进行无人车控制规划流程中的最后实际车辆执行的步骤。





7.5　反馈控制
单独从车辆的姿态控制的角度来看，无人车反馈控制部分和普通的车辆反馈控制并无本质不同。二者都是基于一定的预设轨迹，考虑当前车辆姿态和此预设轨迹的误差并进行不断的跟踪反馈控制。参考资料［12］中列出了很多关于无人车反馈控制的工作，其中［10］［12］［14］等和传统的车辆反馈控制的不同之处在于在传统的反馈控制中加入了基于无人车对障碍物体的避让和路径的优化选择等。在本书提出的整个无人车规划控制的体系架构下，我们的无人车反馈控制部分可以很大程度上借鉴传统的车辆姿态反馈控制的工作。由于这部分工作较为传统和成熟，本书不做为重点来介绍，我们在这里向读者介绍最重要和基本的两个概念：基于车辆的自行车模型，以及PID反馈控制[15][16]。其他车辆姿态反馈控制的工作读者可以参考其他文献。

7.5.1　自行车模型

为了更清楚地描述动作规划中的轨迹生成算法，我们对车辆的模型做了简单的介绍。这里我们更加详细地介绍一种无人车反馈控制（Feedback Control）中常用的车辆控制模型：自行车模型。自行车模型所代表的车辆姿态处于一个二维的平面坐标系内。车辆的姿态（pose）可以由车辆所处的位移（position）及车身和坐标平面的夹角（heading）完全描述。在该模型下，我们认为车辆前后轮由一个刚性（rigid）不变的轴连接，其中车辆的前轮可以在一定的角度范围内自由转动，而车辆的后轮保持和车身的平行关系不能转动。前轮的转动对应实际车辆控制中方向盘的转动。这种自行车模型的一个重要特征是：车辆无法在不做出向前移动的情况下进行横向位移。这种特征又称作非完整性约束（nonholonomic constraint）。在车辆模型中，这种约束根据坐标系的选择不同，往往以不同形式的车辆动作姿态微分方程的形式呈现。另外读者需要注意的是，为了使模型的计算简单，我们忽略车辆的惯性及轮胎接触地面点的打滑。在速度较低的情况下，惯性效应带来的误差较小可以忽略；但是在高速运动时，惯性效应对反馈控制的影响往往是不能忽略的。高速状态下考虑惯性的车辆动力学模型更复杂，不在本书讨论的范围之内。

车辆的自行车模型所代表的车辆姿态如图7-14所示。这里使用一个基于x-y的二维平面，其中分别代表其x和y方向的单元向量。向量和向量pf分别代表车辆后轮和前轮与地面的接触点。车辆的朝向角 $\theta$ 代表车辆和x轴的夹角（即向量pr和单元向量的夹角）。方向盘转角δ定义为前轮朝向和车辆朝向角的夹角。其中前后轮与地面接触点的向量pf和pr之间满足：

其中分别代表车辆前后轮在和地面接触点处的瞬时速度向量。考虑车辆的后轮速度在x-y轴的投影标量，以及后轮的切向速度，那么上述的向量pf和pr之间的关系限制在后轮相关分量上的表现形式为：

其中l代表车辆前后轴中心间距。类似地，用车辆前轮相关分量的表现形式为：

这里前后轮的切向速度标量大小满足：。

图7-14　车辆控制的自行车模型[4]

在上述车辆模型下，反馈控制需要解决的问题之一便是找到满足车辆动态姿态限制的方向盘转角及前向速度。值得一提的是，为了简化计算，往往直接考虑朝向角的变化率ω而非实际的方向盘转角δ。这样便有，问题简化为寻找满足条件的朝向角变化率，而这样的近似常常被称为独轮车模型（Unicycle Model），其特点是前进速度vr被简化为只与朝向角度变化率和轴长相关。

7.5.2　PID反馈控制

一个典型的PID反馈控制系统的结果如图7-15所示。其中e（t）代表当前的跟踪误差，而这个跟踪的变量误差可以是轨迹的纵向/横向误差、角度/曲率误差或者是若干车辆姿态状态变量的综合误差。其中P控制器代表对当前误差的反馈，其增益由KP控制；I和D控制器分别代表积分项和微分项，其增益分别由KI和KD控制。

图7-15　基于PID的反馈控制系统[15]

具体到无人车的反馈控制模块，我们需要解决的问题是控制车辆尽可能遵循上游动作规划所输出的时空轨迹。这里我们借鉴参考资料［12］中的思路，使用两个基于PID反馈控制的控制器分别控制方向盘转角δ及前进速度vs。其中在n采样时刻，控制方向盘转角的PID控制器如下：

其中代表当前车辆朝向和动作规划输出的基准轨迹点（Reference Point）之间的跟踪角度误差，代表在横向位置相对于基准轨迹点（Reference Point）的误差，代表车辆在纵向方向的速度。在车辆纵向方向的PID控制器主要考虑车辆的轨迹曲率和动作规划输出的基准点曲率。根据曲率，我们可以设计一个跟踪速度误差的函数，那么在纵向的目标速度变为：。根据此目标速度和当前车辆姿态的前进速度，前进速度的PID控制器可以写成：

其中分别代表当前比例项、积分项和微分项的增益，UV代表该采样周期输出的油门控制反馈。

以上两种对于方向盘和油门分别设计的PID控制器可以认为是最基本的无人车反馈控制的实现单元。为了使行驶过程更加平滑顺畅舒适，往往在曲率误差较大时，需要设计更复杂的反馈控制系统对车辆进行控制。对于车辆按照预设轨迹的精确控制并不是无人驾驶的特有问题，且已经有很多可行的解决方案，感兴趣的读者可以参考参考资料［12］［17］。



7.6　无人车规划控制结语

作者认为整个无人车广义规划控制范畴下的路由寻径、行为决策、动作规划及反馈控制等几大模块，在当前的学术界和工业界都有一些较成熟的解决方案可以借鉴。这些解决方案有些有着牢固的理论基础和数学推导，还有的在实际的无人车相关工程实践中有着出色的表现。事实上，我们认为单独看控制规划每个层面需要解决的问题，都不是非常困难。如何将整个无人车规划控制的问题有效清晰地划分到不同的模块，并且将各个上下游模块的解决方案配合起来达到整体的协调效果，才是无人车广义规划控制的难点和挑战所在。从这个角度讲，本书并不着力于以调研的形式介绍所有模块层面的现存解决方案，而是着眼于清晰地提供一套有效划分无人车控制规划这一复杂问题到不同层面子问题的方法。我们试图向读者展示，如何有效地将无人车控制规划这样一个复杂问题自上而下地进行分割，并且明确每个层面需要解决的具体问题的范围和限制。在这个基础上，我们再详细介绍每个模块的一种或几种可行的解决算法。我们希望通过展示这样的“分而治之”的控制规划解决思路，有益于读者对整个无人车控制规划系统运作的了解。


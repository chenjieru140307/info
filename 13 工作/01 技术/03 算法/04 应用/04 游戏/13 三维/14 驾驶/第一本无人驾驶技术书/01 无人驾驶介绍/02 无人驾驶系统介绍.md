# 无人驾驶系统介绍


无人驾驶技术是多个技术的集成，包括传感器、定位与深度学习、高精地图、路径规划、障碍物检测与规避、机械控制、系统集成与优化、能耗与散热管理等。



系统主要由三部分组成：算法端、Client端和云端。


无人驾驶系统架构图：


<p align="center">
    <img width="50%" height="50%" src="http://images.iterate.site/blog/image/20200207/PCDniSs9REDm.png?imageslim">
</p>


其中：

- 算法端包括面向传感、感知和决策等关键步骤的算法；
- Client端包括机器人操作系统及硬件平台；
- 云端包括数据存储、模拟、高精度地图绘制及深度学习模型训练。

主要作用：

- 算法端从传感器原始数据中提取有意义的信息以了解周遭的环境情况，并根据环境变化做出决策。
- Client端融合多种算法以满足实时性与可靠性的要求。举例来说，传感器以60Hz的速度产生原始数据，Client端需要保证最长的流水线处理周期也能在16ms内完成。
- 云平台为无人车提供离线计算及存储功能。通过云平台，我们能够测试新的算法、更新高精度地图并训练更加有效的识别、追踪和决策模型。



## 无人驾驶算法

算法系统由几部分组成：

- 第一，传感，并从传感器原始数据中提取有意义信息；
- 第二，感知，以定位无人车所在位置及感知现在所处的环境；
- 第三，决策，以便可靠、安全地抵达目的地。



### 1．传感

通常来说，一辆无人车装备有许多不同类型的主传感器。每一种类型的传感器各自有不同的优劣，因此，来自不同传感器的传感数据应该有效地进行融合。现在无人驾驶中普遍使用的传感器包括以下几种。

- （1）GPS/IMU：GPS/IMU传感系统通过高达200 Hz频率的全球定位和惯性更新数据，以帮助无人车完成自我定位。GPS是一个相对准确的定位用传感器，但是它的更新频率过低，仅有10Hz，不足以提供足够实时的位置更新。IMU的准确度随着时间降低，因此在长时间距离内并不能保证位置更新的准确性；但是，它有着GPS所欠缺的实时性，IMU的更新频率可以达到200Hz或者更高。通过整合GPS与IMU，我们可以为车辆定位提供既准确又足够实时的位置更新。<span style="color:red;">IMU 是什么？</span>
- （2）LIDAR：激光雷达可被用来绘制地图、定位及避障。雷达的准确率非常高，因此在无人车设计中雷达通常被作为主传感器使用。激光雷达是以激光为光源，通过探测激光与被探测物相互作用的光波信号来完成遥感测量。激光雷达可以用来产生高精度地图，并针对高精地图完成移动车辆的定位，以及满足避障的要求。以Velodyne 64-束激光雷达为例，它可以完成10Hz旋转并且每秒可达到130万次读数。
- （3）摄像头：摄像头被广泛使用在物体识别及物体追踪等场景中，在车道线检测、交通灯侦测、人行道检测中都以摄像头为主要解决方案。为了加强安全性，现有的无人车实现通常在车身周围使用至少八个摄像头，分别从前、后、左、右四个维度完成物体发现、识别、追踪等任务。这些摄像头通常以60Hz的频率工作，当多个摄像头同时工作时，将产生高达1.8GB每秒的巨额数据量。
- （4）雷达和声呐：雷达把电磁波的能量发射至空间中某一方向，处在此方向上的物体反射该电磁波，雷达通过接收此反射波，以提取该物体的某些有关信息，包括目标物体至雷达的距离、距离变化率或径向速度、方位、高度等。雷达和声呐系统是避障的最后一道保障。雷达和声呐产生的数据用来表示在车的前进方向上最近障碍物的距离。一旦系统检测到前方不远有障碍物出现，则有极大的相撞危险，无人车会启动紧急刹车以完成避障。因此，雷达和声呐系统产生的数据不需要过多的处理，通常可直接被控制处理器采用，并不需要主计算流水线的介入，因此可实现转向、刹车或预张紧安全带等紧急功能。<span style="color:red;">怎么直接采用，是怎么做到不需要主计算流水线介入的？</span>


### 2．感知

在获得传感信息之后，数据将被推送至感知子系统以充分了解无人车所处的周遭环境。在这里感知子系统主要做的是三件事：定位、物体识别与追踪。

- 1）定位

GPS以较低的更新频率提供相对准确的位置信息，IMU则以较高的更新频率提供准确性偏低的位置信息。我们可以使用卡尔曼滤波整合两类数据各自的优势，合并提供准确且实时的位置信息更新。如图所示，IMU每5ms更新一次，但是期间误差不断累积精度不断降低。所幸的是，每100ms，我们可以得到一次GPS数据更新，以帮助我们校正IMU积累的误差。因此，我们最终可以获得实时并准确的位置信息。<span style="color:red;">为什么IMU 会误差不断累积？怎么进行卡尔曼滤波整合？</span>

然而，我们不能仅仅依靠这样的数据组合完成定位工作。原因有三：其一，这样的定位精度仅在一米之内；其二，GPS信号有着天然的多路径问题将引入噪声干扰；其三，GPS必须在非封闭的环境下工作，因此在诸如隧道等场景中GPS都不适用。

基于GPS/IMU定位的原理图:


<p align="center">
    <img width="50%" height="50%" src="http://images.iterate.site/blog/image/20200208/RArEFncPGpDr.png?imageslim">
</p>


因此作为补充方案，摄像头也被用于定位：


<p align="center">
    <img width="50%" height="50%" src="http://images.iterate.site/blog/image/20200208/Bt59YycBugHF.png?imageslim">
</p>

基于视觉的定位由三个基本步骤组成：

1. 通过对立体图像的三角剖分，首先获得视差图用以计算每个点的深度信息；<span style="color:red;">怎么得到立体图像？</span>
2. 通过匹配连续立体图像帧之间的显著特征，可以通过不同帧之间的特征建立相关性，并由此估计这两帧之间的运动情况；
3. 通过比较捕捉到的显著特征和已知地图上的点计算车辆的当前位置。

然而，基于视觉的定位方法对照明条件非常敏感，因此其使用受限且可靠性有限。

因此，借助于大量粒子滤波的激光雷达通常被用作车辆定位的主传感器。由激光雷达产生的点云对环境进行了“形状化描述”，但并不足以区分各自不同的点。通过粒子滤波，系统可将已知地图与观测到的具体形状进行比较以减少位置的不确定性。<span style="color:red;">已知地图是什么？</span>


为了在地图中定位运动的车辆，可以使用粒子滤波的方法关联已知地图和激光雷达测量过程。粒子滤波可以在10cm的精度内达到实时定位的效果，在城市的复杂环境中尤为有效。然而，激光雷达也有其固有的缺点：如果空气中有悬浮的颗粒（比如雨滴或者灰尘），那么测量结果将受到极大的扰动。<span style="color:red;">怎么关联？</span>

因此，我们需要利用多种传感器融合技术进行多类型传感数据融合，处理以整合所有传感器的优点，完成可靠并精准的定位。

定位中的多传感器融合：

<p align="center">
    <img width="50%" height="50%" src="http://images.iterate.site/blog/image/20200208/t0KXJfcJfQ13.png?imageslim">
</p>



- 2）物体识别与跟踪

激光雷达可提供精准的深度信息，因此常被用于在无人驾驶中执行物体识别和追踪的任务。近年来，深度学习技术得到了快速的发展，通过深度学习可达到较显著的物体识别和追踪精度。

卷积神经网络（CNN）是一类在物体识别中被广泛应用的深度神经网络。一旦某物体被CNN识别出来，下一步将自动预测它的运行轨迹或进行物体追踪，如图1-7所示。

<p align="center">
    <img width="50%" height="50%" src="http://images.iterate.site/blog/image/20200208/4f9cfDp45YiF.png?imageslim">
</p>


物体追踪可以被用来追踪邻近行驶的车辆或者路上的行人，以保证无人车在驾驶的过程中不会与其他移动的物体发生碰撞。近年来，相比传统的计算机视觉技术，深度学习技术已经展露出极大的优势，通过使用辅助的自然图像，离线的训练过程可以从中学习图像的共有属性以避免视点及车辆位置变化造成的偏移，离线训练好的模型直接应用在在线的物体追踪中。

### 3．决策

在决策阶段，行为预测、路径规划及避障机制三者结合起来实时地完成无人驾驶动作规划。

1）行为预测

在车辆驾驶中主要考验的是司机如何应对其他行驶车辆的可能行为，这种预判断直接影响司机本人的驾驶决策，特别是在多车道环境或者交通灯变灯的情况下，司机的预测决定了下一秒行车的安全。因此，过渡到无人驾驶系统中，决策模块如何根据周围车辆的行驶状况决策下一秒的行驶行为显得至关重要。

为了预测其他车辆的行驶行为，可以使用随机模型产生这些车辆的可达位置集合，并采用概率分布的方法预测每一个可达位置集的相关概率。

面向行为预测的随机模型示意：

<p align="center">
    <img width="50%" height="50%" src="http://images.iterate.site/blog/image/20200208/RUoes88tfH9n.png?imageslim">
</p>


2）路径规划

为无人驾驶在动态环境中进行路径规划是一件非常复杂的事情，尤其是在车辆全速行驶的过程中，不当的路径规划有可能造成致命的伤害。路径规划中采取的一个方法是使用完全确定模型，它搜索所有可能的路径并利用代价函数的方式确定最佳路径。然后，完全确定模型对计算性能有着非常高的要求，因此很难在导航过程中达到实时的效果。为了避免计算复杂性并提供实时的路径规划，使用概率性模型成为了主要的优化方向。<span style="color:red;">的确比较复杂，比开始想的要复杂。</span>

3）避障

安全性是无人驾驶中最重要的考量，我们将使用至少两层级的避障机制来保证车辆不会在行驶过程中与障碍物发生碰撞。

- 第一层级是基于交通情况预测的前瞻层级。交通情况预测机制根据现有的交通状况如拥堵、车速等，估计出碰撞发生时间与最短预测距离等参数。基于这些估计，避障机制将被启动以执行本地路径重规划。
- 如果前瞻层级预测失效，则第二级实时反应层将使用雷达数据再次进行本地路径重规划。一旦雷达侦测到路径前方出现障碍物，则立即执行避障操作。




## 用户端系统

用户端系统整合上述避障、路径规划等算法，以满足可靠性及实时性等要求。

用户端系统需要克服三个方面的问题：

- 其一，系统必须确保捕捉到的大量传感器数据可以及时快速地得到处理；
- 其二，如果系统的某部分失效，则系统需要有足够的健壮性能从错误中恢复；
- 其三，系统必须在设计的能耗和资源限定下有效地完成所有的计算操作。

### 1．机器人操作系统

机器人操作系统ROS是现如今广泛被使用的、专为机器人应用裁剪的、强大的分布式计算框架。ROS为机器人应用提供诸如硬件抽象描述、底层驱动程序管理、消息管理与传递、程序发行包管理等基本功能，同时也提供一系列工具和库用于开发、获取和运行机器人应用。节点（node）是ROS中的基本单位，其粒度范围很广，小到一个传感器大到一个完整的机器人都可以是一个节点。每一个机器人任务，比如避障，也作为ROS中的一个节点存在。节点与节点之间通过消息互相通信，其通信是端对端的，消息可以按照主题分类，也可以包装成远程服务调用的形式。ROS中的节点管理器和消息管理器提供命名和查找服务以方便节点在运行时能找到彼此。

ROS操作系统结构示意图：

<p align="center">
    <img width="50%" height="50%" src="http://images.iterate.site/blog/image/20200208/cT44cGzkPDDx.png?imageslim">
</p>


ROS非常适用于无人驾驶的场景，但是仍有一些问题需要解决。

- 可靠性：ROS使用单主节点结构，并且没有监控机制以恢复失效的节点。
- 性能：当节点之间使用广播消息的方式通信时，将产生多次信息复制导致性能下降。
- 安全：ROS中没有授权和加密机制，因此安全性受到很大的威胁。

尽管ROS 2.0承诺将解决上述问题，但是现有的ROS版本中仍然没有相关的解决方案。因此，为了在无人驾驶中使用ROS，我们需要自行克服这些难题。

1）可靠性

现有的ROS实现只有一个主节点，因此当主节点失效时，整个系统也随之崩溃。这对行驶中的汽车而言是致命的缺陷。为了解决此问题，我们在ROS中使用类似于ZooKeeper的方法。如图所示，改进后的ROS结构包括一个关键主节点及一个备用主节点。如果关键主节点失效，则备用主节点将被自动启用以确保系统能够无缝地继续运行。此外，ZooKeeper机制将监控并自动重启失效节点，以确保整个ROS系统在任何时刻都是双备份模式。<span style="color:red;">不错，ZooKeeper 了解下。</span>

面向ROS的ZooKeeper结构：

<p align="center">
    <img width="50%" height="50%" src="http://images.iterate.site/blog/image/20200208/RhjcKIQXwt0C.png?imageslim">
</p>


2）性能

性能是现有ROS版本中有欠考虑的部分，ROS节点之间的通信非常频繁，因此设计高效的通信机制对保证ROS的性能势在必行。首先，本地节点在与其他节点通信时使用回环机制，并且每一次回环通信的执行都将完整地通过TCP/IP全协议栈，从而引入高达20微秒的时延。为了消除本地节点通信的代价，我们不再使用TCP/IP的通信模式，取而代之地采用共享内存的方法完成节点通信。其次，当ROS节点广播通信消息时，消息被多次复制与传输，消耗了大量的系统带宽。如果改成目的地更明确的多路径传输机制则将极大地改善系统的带宽与吞吐量：

多路传播和广播的通信性能比较：


<p align="center">
    <img width="50%" height="50%" src="http://images.iterate.site/blog/image/20200208/bqXJF3wJiJRs.png?imageslim">
</p>



3）安全

安全是ROS系统中最重要的需求。如果一个ROS节点被挟制后，则会不停地进行内存分配，整个系统最终将因内存耗尽而导致剩余节点失效继而全线崩溃。在另一个场景中，因为ROS节点本身没有加密机制，黑客可以很容易地在节点之间窃听消息并完成系统入侵。

为了解决安全问题，我们使用Linux containers（LXC）的方法限制每一个节点可供使用的资源数，并采用沙盒的方式以确保节点的运行独立，这样以来可最大限度地防止资源泄露。同时，我们为通信消息进行了加密操作，以防止其被黑客窃听。<span style="color:red;">LXC 是什么？怎么采用沙盒方式来确保节点的独立运行的？</span>

### 2．硬件平台

为了深入理解设计无人驾驶硬件平台中可能遇到的挑战，让我们来看看现有的领先无人车驾驶产品的计算平台构成。此平台由两个计算盒组成，每一个装备有INTEL Xeon E5处理器及4到8个Nvidia Tesla K80 GPU加速器。两个计算盒执行完全一样的工作，第二个计算盒作为计算备份以提高整个系统的可靠性，一旦第一个计算盒发生故障，计算盒二可以无缝地接手所有的计算工作。

在极端的情况下，如果两个计算盒都在峰值下运行，及时功耗将高达5000W，同时也将遭遇非常严重的发热问题。因此，计算盒必须配备有额外的散热装置，可采用多风扇或者水冷的方案。同时，每一个计算盒的造价非常昂贵，高达2万至3万美元，致使现有无人车方案对普通消费者而言无法承受。

现有无人车设计方案中存在的功耗问题、散热问题及造价问题使得无人驾驶进入普罗大众显得遥不可及。为了探索无人驾驶系统在资源受限及能耗受限时运行的可行性，我们在ARM面向移动市场的SoC实现了一个简化的无人驾驶系统，实验显示，在峰值情况下能耗仅为15W。<span style="color:red;">什么是 SoC？</span>

非常惊人地，在移动类SoC上，无人驾驶系统的性能反而带给了我们一些惊喜：定位算法可以达到每秒25帧的处理速度，同时能维持图像生成的速度在30帧每秒。深度学习则能在一秒内完成2～3个物体的识别工作。路径规划和控制则可以在6毫秒之内完成规划工作。在性能的驱动下，我们可以在不损失任何位置信息的情况下达到每小时5迈（8km）的行驶速度。<span style="color:red;">只能完成 2~3 个物体的识别，会不会有问题。</span>

## 云平台

无人车是移动系统，因此需要云平台的支持。云平台主要从分布式计算及分布式存储两方面对无人驾驶系统提供支持。

无人驾驶系统中很多的应用，包括用于验证新算法的仿真应用、高精度地图产生和深度学习模型训练都需要云平台的支持。我们使用Spark构建了分布式计算平台，使用OpenCL构建了异构计算平台，使用Alluxio作为内存存储平台。通过这三个平台的整合，可以为无人驾驶提供高可靠、低延迟及高吞吐的云端支持。<span style="color:red;">很好呀。怎么使用 Spark 构建分布式计算平台的？怎么使用 OpenCL 构建异构计算平台的？怎么使用 Alluxio 构建内存存储平台的？</span>

1．仿真

当我们为无人驾驶开发出新算法时，需要先通过仿真对此算法进行全面测试，测试通过之后才进入真车测试环节。真车测试的成本非常高昂并且迭代周期异常漫长，因此仿真测试的全面性和正确性对降低生产成本和生产周期尤为重要。在仿真测试环节，我们通过在ROS节点回放真实采集的道路交通情况，模拟真实的驾驶场景，完成对算法的测试。如果没有云平台的帮助，单机系统耗费数小时才能完成一个场景下的模拟测试，既耗时测试覆盖面又有限。

在云平台中，Spark管理着分布式的多个计算节点，在每一个计算节点中，都可以部署一个场景下的ROS回访模拟。在无人驾驶物体识别测试中，单服务器需耗时3小时完成算法测试，如果使用8机Spark机群，则时间可以缩短至25分钟，如图1-12所示。

<span style="color:red;">怎么做的 ROS 的回访模拟的？</span>

<p align="center">
    <img width="50%" height="50%" src="http://images.iterate.site/blog/image/20200208/ycEHnEdWhJGt.png?imageslim">
</p>



2．高精度地图生成

如图1-13所示，高精度地图的产生过程非常复杂，涉及原始数据处理、点云生成、点云对齐、2D反射地图生成、高精地图标注、地图生成等阶段。使用Spark可以将所有这些阶段整合成一个Spark作业。由于Spark天然的内存计算的特性，在作业运行过程中产生的中间数据都存储在内存中。当整个地图生产作业提交之后，不同阶段之间产生的大量数据不需要使用磁盘存储，数据访问速度加快，从而极大提高精度了高地图产生的性能。

基于云平台的高精度地图生成流程图：

<p align="center">
    <img width="50%" height="50%" src="http://images.iterate.site/blog/image/20200208/EfUDg08tVAJR.png?imageslim">
</p>

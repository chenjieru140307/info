
# 可以补充进来的

- 这个是读取底层 API 的，重新确认下。

# 当人工智能遇见黑暗之魂 如何使用神经网络训练一个PVP AI


## 一、介绍

《黑暗之魂》是由From Software公司制作的一款角色扮演游戏，一直以难度高而著称。在游戏中，除了和怪物进行PVE的战斗外，你还可以以“入侵”的形式进入到其他玩家的世界中，与网友进行一场PVP的较量。

最近，我在Github上发现了一个神奇的项目：[metal-crow/Dark-Souls-PvP-AI](https://link.zhihu.com/?target=https%3A//github.com/metal-crow/Dark-Souls-PvP-AI) 。这个项目由国外网友metal-crow花费10个月制作完成，它在《黑暗之魂》中用神经网络实现了一个PVP AI，非常的有意思。我正好利用周末研究了一下这个项目，并用这篇文章做一个简单介绍。有兴趣的同学还可以自行去Github上翻看源码。

首先让我们来看下AI长什么样子，下图的“红灵”就是电脑控制的AI：

![img](https://pic4.zhimg.com/v2-a5d66a90ea24202a1cd246d3db69bbcb_b.jpg)

AI可以轻松躲过敌人的攻击：

![img](https://pic2.zhimg.com/v2-c69be0090ceaedf29760abc36a842411_b.jpg)

AI的主要攻击方式是闪躲到敌人背后进行“背刺”：

![img](https://pic4.zhimg.com/v2-b5ab3796af9a98122d75de488d80219b_b.jpg)

最后，当AI战胜敌人时，还会鞠躬致意：

![img](https://pic3.zhimg.com/v2-bb5f99d9646507e03d99fc12707d1bc2_b.jpg)

如果上面的图片看得不过瘾，这里还有两个视频可以围观，一个是原作者制作的[介绍视频](https://link.zhihu.com/?target=https%3A//www.youtube.com/watch%3Fv%3DxPrB8jJ4oGU)，还有一个是另外一个网友制作的和该AI对战的[视频](https://link.zhihu.com/?target=https%3A//www.youtube.com/watch%3Fv%3DS65DWqqn5gE)。原始视频都放在Youtube上，为了方便国内用户观看，我把它们都搬运到了优酷上：



国外网友制作的黑暗之魂1 PVP AI—在线播放—优酷网，视频高清在线观看

视频





黑暗之魂1 PVP AI 对战视频—在线播放—优酷网，视频高清在线观看

视频



## 二、实现原理

以上是对这个项目的基本介绍，下面，我们来一起看下这个项目的技术原理。

制作这样一个AI有两种方式：

1. 直接从游戏的画面出发，使用计算机视觉的方法输出动作。
2. 从内存中读取游戏数据，根据游戏数据输出动作。

在《黑暗之魂》中，由于敌人和环境的不同，直接从原始画面预测操作非常困难，为此作者采用了第二种方法，先使用CE（Cheat Engine，著名游戏内存修改工具）读取游戏中需要的数据，如角色的位置、角色的生命、耐力、角色的动作等，根据这些数据来制作AI。

按理说，我们读取游戏的内存数据后，就可以直接制定一些规则了，这就是传统的制作简单AI的方式。**但是，原作者却使用了神经网络，这是为什么呢？其实，这主要是源自《黑暗之魂》PVP对战中的一个重要设定：背刺**。

在PVP对战中，玩家往往会使用背刺的战术，他们会相互试探，当发现时机时，就会进行滚动 + 背刺，整个过程在几帧内就可以完成。**对于普通的攻击，敌人攻击起手后，AI得到起手的数据，就可以轻松地躲开，但是我们很难通过一套规则，判定敌人什么时候会突然发动背刺**。这导致制作出来的AI很容易被人抓住漏洞，被背刺击败。

**对此，原作者引入了两个神经网络来进行预测。**一个网络叫Defense Network，用来预测应该采取怎样的防御动作。一个网络叫Attack Network，用来判断是否应当攻击以及采取何种方式攻击。

Defense Network的输入为以下值：

- 每隔0.5秒，AI和敌人之间的距离时间序列。
- AI和敌人之间的角度
- 敌人的速度
- AI和敌人面对的角度

程序是用纯c编写的，因此可以比较方便的读取游戏的内存。读取的原始数据为AI和敌人的坐标和方位，通过基本的计算后就可以得到Defense Network的输入值。

Attack Network的输入为以下值：

- AI和敌人之间的距离时间序列。
- 估测的敌人的耐力（这个数据实际可以直接读取内存获取，但在游戏界面上是不显示的，因此，为了公平起见，不使用从内存中读取的值，而使用估测值）
- 敌人当前的动作
- 敌人当前动作可能造成的伤害
- AI当前的动作
- AI当前的动作可能造成的伤害
- AI的生命值
- AI的耐力值
- AI的动画类型
- AI是否处于流血状态

同Defense Network一样，这些输入值要么可以从内存中直接读到，要么可以通过读取的值进行计算。

**Defense Network和Attack Network的输出值是应该采取的动作指令，由于这些动作指令是事先定义好的，因此这两个神经网络的输出就等同于机器学习中的分类问题。**

最后，在程序实际运行时，Defense Network和Attack Network的输出值会被当做一种“建议指令”，辅助主程序进行决策。除了这两个神经网络外，一些规则也是必要的，如在敌人喝药的时候AI如果距离够远，也会停下来喝药。这些都是事先设定好的。所有设定好的规则都在代码[AIDecisions.c](https://link.zhihu.com/?target=https%3A//github.com/metal-crow/Dark-Souls-PvP-AI/blob/master/Dark%2520Souls%2520AI%2520C/AIDecisions.c)中。

## 三、总结

个人感觉这个项目还是非常有意思的。在游戏PVP对战的过程中，我们要预判某些动作（如背刺）可能发动的“时机”。

这种“时机”没有办法通过读取内存来判定，因此我们只能通过敌人的走位信息（即Defense Network的输入）来预测敌人的意图，这种预测的工作就可以交由神经网络完成。

最后，这个项目的平台是《黑暗之魂1》，但公布的时间在《黑暗之魂3》正式发布前夕。当时，《黑暗之魂1》已经是一个比较老的游戏了，活跃在Steam《黑暗之魂1》上的PVP玩家大多是一些经验丰富的“老司机”，但是该AI依然取得了大部分战斗的胜利，可以说是非常厉害了：）


# 相关

- [当人工智能遇见黑暗之魂：如何使用神经网络训练一个PVP AI](https://zhuanlan.zhihu.com/p/27657068)
